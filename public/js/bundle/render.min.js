function upd_progessbar(e,a){var r=e.find("span");e.attr("aria-valuenow",a),e.css("width",a+"%"),r.text(a+"% Complete")}function upd_progessbar(e,a){var r=e.find("span");e.attr("aria-valuenow",a),e.css("width",a+"%"),r.text(a+"% Complete")}$(function(){var s={},o={},t="ba";uniqueId=1;var n=function(e){$("#"+e+" .panel-heading").text(s.beer+" ["+s.brew+"]"),$("#"+e+" #ba_col .text-primary").append(" "+s.score+" / ").append('<span class="text-danger">5</span>');var a=$("#"+e+" .progress-bar");upd_progessbar(a,s.score_percent),$("#"+e+" div.ba_brew").append(" "+s.brew),$("#"+e+" div.ba_beer").append(" "+s.beer),$("#"+e+" div.ba_style").append(" "+s.style),$("#"+e+" div.ba_category").append(" "+s.category),$("#"+e+" div.ba_abv").append(" "+s.abv),$("#"+e+" div.ba_url > a").attr("href",s.url);var r=$("#"+e+" img");r.attr("alt",s.beer+" ["+s.brew+"]"),null!==s.img&&r.removeClass("img-circle").addClass("img-rounded").attr({src:s.img,style:"width:60%"})},i=function(e){$("#"+e+" .panel-heading").text(o.beer),$("#"+e+" div.ap_brew").append(" "+o.brew),$("#"+e+" div.ap_beer").append(" "+o.beer),$("#"+e+" div.ap_style").append(" "+o.style),$("#"+e+" div.ap_country").append(" "+o.country),$("#"+e+" div.ap_abv").append(" "+o.abv),$("#"+e+" div.ap_type").append(" "+o.type),$("#"+e+" div.ap_price").append(" "+o.price),$("#"+e+" div.ap_url > a").attr("href",o.url);var a=$("#"+e+" img");if(a.attr("alt",o.beer+" ["+o.brew+"]"),(null!==o.img&&null!==s.img||null===s.img&&null!==o.img)&&a.removeClass("img-circle").addClass("img-responsive").attr({src:o.img}),null!==s.img&&null===o.img&&a.removeClass("img-circle").addClass("img-rounded").attr({src:s.img}),o.desc.hasOwnProperty("0")){console.log("ap.desc: "+JSON.stringify(o.desc,null,2)+"\nap.beer: "+o.beer);var r=$("#"+e+" #modal");r.removeClass("hidden").find("#apModalLabel").text(o.beer+" ["+o.brew+"]");var t="";for(prop in o.desc)t+='<div class="text-info">'+o.desc[prop]+"</div><br>";r.find(".ap_desc").append(t),r.find("a").attr("href",o.url)}var n=$("#"+e+" #ap_col");void 0!==o.sostav&&n.find("#ap_sostav").removeClass("hidden").append(" "+o.sostav),void 0!==o.tara&&n.find("#ap_tara").removeClass("hidden").append(" "+o.tara),void 0!==o.past&&n.find("#ap_past").removeClass("hidden").append(" "+o.past),void 0!==o.density&&n.find("#ap_density").removeClass("hidden").append(" "+o.density),void 0!==o.taste&&n.find("#ap_taste").removeClass("hidden").append(" "+o.taste),void 0!==o.filter&&n.find("#ap_filter").removeClass("hidden").append(" "+o.filter)};$("#form-submit").click(function(e){$('[id*="clone"]').remove();var r=$("#f1").val()||$("#f1").attr("placeholder");console.log("query: "+r),e.preventDefault();var a=Ladda.create(this);return a.start(),$.get("/api/es/"+r,function(e){console.log("HTTP response OK");var a=$("#dataset").removeClass("hidden").addClass("container");0===e.length?a.find(".jumbotron").html('<div class="alert alert-danger"><strong>404</strong> Beer "'+r+'" not found!</div>'):a.find(".alert.alert-danger").remove(),e.forEach(function(e){json_obj=e._source;var a="clone"+uniqueId;$(".panel-primary").not('[id*="clone"]').clone().appendTo("#ba_jumbotron_hid").attr("id",a),json_obj.hasOwnProperty("Название")&&json_obj.hasOwnProperty("BA_beer")?(t="apba",s.score=json_obj.BA_score,s.beer=json_obj.BA_beer,s.brew=json_obj.BA_brewary,s.style=json_obj.BA_style,s.category=json_obj.BA_category,s.abv=json_obj.BA_abv,s.url=json_obj.BA_url,s.score_percent=Math.round(json_obj.BA_score/.05),o.beer=json_obj.Название,o.brew=json_obj.brewary,o.style=json_obj["Вид пива"],o.country=json_obj["Страна"],o.abv=json_obj.Крепость,o.type=json_obj["Тип брожения"],o.price=json_obj.Цена,o.vol=json_obj.vol,o.tara=json_obj.Тара,o.url=json_obj.url,o.desc=json_obj.desc,o.img=json_obj.img,o.past=json_obj.Пастеризация,o.density=json_obj.Плотность,o.taste=json_obj["Вкусовые оттенки"],o.filter=json_obj.Фильтрация,o.sostav=json_obj.Состав):json_obj.hasOwnProperty("Название")?json_obj.hasOwnProperty("BA_beer")||(t="ap",o.beer=json_obj.Название,o.brew=json_obj.brewary,o.style=json_obj["Вид пива"],o.country=json_obj["Страна"],o.abv=json_obj.Крепость,o.type=json_obj["Тип брожения"],o.price=json_obj.Цена,o.vol=json_obj.vol,o.tara=json_obj.Тара,o.url=json_obj.url,o.desc=json_obj.desc,o.img=json_obj.img,o.past=json_obj.Пастеризация,o.density=json_obj.Плотность,o.taste=json_obj["Вкусовые оттенки"],o.filter=json_obj.Фильтрация,o.sostav=json_obj.Состав,$('[id*="clone"] #ba_col').remove()):(t="ba",s.score=json_obj.score,s.beer=json_obj.beer,s.brew=json_obj.brewary,s.style=json_obj.style,s.category=json_obj.category,s.abv=json_obj.Крепость,s.score_percent=json_obj.score_percent,s.url=json_obj.url,s.img=json_obj.img,$('[id*="clone"] #ap_col').remove()),"ba"===t?n(a):("ap"===t||n(a),i(a)),uniqueId++})},"json").always(function(){a.stop()}),!1})}),$(function(){var s={},o={},t="ba",n=1,i={},d={};i={query:{beer:$("#f1").attr("placeholder")},action:"search"},$("#abv_slider").slider({}),$(".panel-heading").find("a").click(function(e){var a=$("#abv_slider").attr("value").split(","),r=Number(a[0]),t=Number(a[1]);console.log("val1: "+r+"\nval2: "+t),d.logic={arr:[{$or:[{ba_abv:{$gte:r}},{ap_abv:{$gte:r}}]},{$or:[{ba_abv:{$lt:t}},{ap_abv:{$lt:t}}]}]},$("#abv_slider").on("slide",function(e){r=Number(e.value[0]),t=Number(e.value[1]),d.logic={arr:[{$or:[{ba_abv:{$gte:r}},{ap_abv:{$gte:r}}]},{$or:[{ba_abv:{$lt:t}},{ap_abv:{$lt:t}}]}]}}),d.brew=$("#f2").attr("placeholder"),$("#f2").click(function(){d.brew="",$(this).attr("placeholder","")}),$("#f2").keyup(function(e){d.brew=$("#f2").val()})}),$(".btn.btn-default.dropdown-toggle").text("Ales"),i.query.style=$(".btn.btn-default.dropdown-toggle").text(),$(".dropdown-menu").find("li").first().before('<li role="presentation"><a class="reset" role="menuitem" tabindex="-1">Reset filter</a></li><li role="presentation" class="divider"></li>'),$(".dropdown-menu").find("a").click(function(){d.style=$(this).text(),i.query.query_type="advanced",i.query.style=d.style,$(".btn.btn-default.dropdown-toggle").text(d.style),"reset"===$(this).attr("class")&&(delete i.query.query_type,delete i.query.style,$(".btn.btn-default.dropdown-toggle").text("Beer Style"))}),$("#f1").click(function(e){$(this).attr("placeholder","")});var l="/api/mongo";$("#form-submit").click(function(e){$('[id*="clone"]').remove();var a=$("#f1").val()||$("#f1").attr("placeholder");if(i.query.beer=a,"true"===$(".panel-heading").find("a").attr("aria-expanded")?d.hasOwnProperty("brew")&&(i.query.brew=d.brew,i.query.logic=d.logic,i.query.query_type="advanced"):delete i.query.query_type,i.query.brew||delete i.query.brew,i.query.beer||delete i.query.beer,console.log("post_body: "+JSON.stringify(i,null,2)),i.query.beer||i.query.hasOwnProperty("query_type")){e.preventDefault();var r=Ladda.create(this);r.start(),$("#paginator").removeClass("container").addClass("hidden").find("ul").remove(),$("#ba_jumbotron_hid").removeClass("jumbotron").addClass("hidden").after('<img id="spinner" src="../images/spinner2.gif">');var t=$.ajax({url:l,type:"POST",data:JSON.stringify(i),contentType:"application/json; charset=utf-8",dataType:"json"});return t.fail(function(e,a){r.stop(),$("#spinner").remove(),$("#ba_jumbotron_hid").removeClass("hidden").addClass("jumbotron"),$(".ladda-spinner").remove(),console.log("Request failed.\nStatus:"+e.status+"\nStatus text: "+e.statusText+"\nError message: "+a)}),t.done(function(e){r.stop(),$("#spinner").remove(),$(".ladda-spinner").remove(),$("#ba_jumbotron_hid").removeClass("hidden").addClass("jumbotron"),c(e,a)}),!1}console.log("error"),$(".ladda-spinner").remove(),$(".alert.alert-danger.fade.in.alert-dismissible").remove(),$("#paginator").removeClass("container").addClass("hidden").find("ul").remove(),$("#dataset").removeClass("hidden").find("#ba_jumbotron_hid").addClass("jumbotron").append('<div class="alert alert-danger fade in alert-dismissible">Поле пиво может быть пустым только с дополнительными параметрами поиска</div>')});var p=function(e){$("#"+e+" .panel-heading").text(s.beer+" ["+s.brew+"]"),$("#"+e+" #ba_col .text-primary").append(" "+s.score+" / ").append('<span class="text-danger">5</span>');var a=$("#"+e+" .progress-bar");upd_progessbar(a,s.score_percent),$("#"+e+" div.ba_brew").append(" "+s.brew),$("#"+e+" div.ba_beer").append(" "+s.beer),$("#"+e+" div.ba_style").append(" "+s.style),$("#"+e+" div.ba_category").append(" "+s.category),$("#"+e+" div.ba_abv").append(" "+s.abv),$("#"+e+" div.ba_url > a").attr("href",s.url);var r=$("#"+e+" img");r.attr("alt",s.beer+" ["+s.brew+"]"),null!==s.img&&r.removeClass("img-circle").addClass("img-rounded").attr({src:s.img,style:"width:60%"})},b=function(e){$("#"+e+" .panel-heading").text(o.beer),$("#"+e+" div.ap_brew").append(" "+o.brew),$("#"+e+" div.ap_beer").append(" "+o.beer),$("#"+e+" div.ap_style").append(" "+o.style),$("#"+e+" div.ap_country").append(" "+o.country),$("#"+e+" div.ap_abv").append(" "+o.abv),$("#"+e+" div.ap_type").append(" "+o.type),$("#"+e+" div.ap_price").append(" "+o.price),$("#"+e+" div.ap_url > a").attr("href",o.url);var a=$("#"+e+" img");if(a.attr("alt",o.beer+" ["+o.brew+"]"),(null!==o.img&&null!==s.img||null===s.img&&null!==o.img)&&a.removeClass("img-circle").addClass("img-responsive").attr({src:o.img}),null!==s.img&&null===o.img&&a.removeClass("img-circle").addClass("img-rounded").attr({src:s.img}),o.desc.hasOwnProperty(0)){console.log("ap.desc: "+JSON.stringify(o.desc,null,2)+"\nap.beer: "+o.beer);var r=$("#"+e+" #modal").removeClass("hidden");r.find(".btn.btn-primary").attr("data-target","#modal_"+e),r.find("#apModal").attr("id","modal_"+e),r.find("#apModalLabel").text(o.beer+" ["+o.brew+"]");var t="";for(prop in o.desc)t+='<div class="text-info">'+o.desc[prop]+"</div><br>";r.find(".ap_desc").append(t),r.find("a").attr("href",o.url)}var n=$("#"+e+" #ap_col");void 0!==o.sostav&&n.find("#ap_sostav").removeClass("hidden").append(" "+o.sostav),void 0!==o.tara&&n.find("#ap_tara").removeClass("hidden").append(" "+o.tara),null!==o.density&&n.find("#ap_density").removeClass("hidden").append(" "+o.density),void 0!==o.taste&&n.find("#ap_taste").removeClass("hidden").append(" "+o.taste),void 0!==o.filter&&n.find("#ap_filter").removeClass("hidden").append(" "+o.filter)},c=function(e,a){console.log("HTTP response OK");var r=$("#dataset").removeClass("hidden").addClass("container");0===e.beers.length?r.find(".jumbotron").html('<div class="alert alert-danger"><strong>404</strong> Beer not found!<br>Query: '+JSON.stringify(i.query,null,2)+"</div>"):r.find(".alert.alert-danger").remove(),e.beers.forEach(function(e){var a="clone"+n;$(".panel-primary").not('[id*="clone"]').clone().appendTo("#ba_jumbotron_hid").attr("id",a),e.hasOwnProperty("ap_beer")&&e.hasOwnProperty("ba_beer")?(t="apba",s.score=e.ba_beer_score,s.img=e.ba_img,s.beer=e.ba_beer,s.brew=e.ba_brewary,s.style=e.ba_style,s.category=e.ba_category,s.abv=e.ba_abv,s.url=e.ba_url,s.score_percent=Math.round(e.ba_beer_score/.05),o.beer=e.ap_beer,o.brew=e.ap_brewary,o.style=e.ap_style,o.country=e.ap_country,o.abv=e.ap_abv,o.type=e.ap_type||void 0,o.price=e.ap_price_str,o.vol=e.ap_vol,o.tara=e.ap_tara,o.url=e.ap_url,e.hasOwnProperty("ap_desc")?o.desc=e.ap_desc:o.desc={},o.img=e.ap_img,o.past="",e.hasOwnProperty("ap_density")?o.density=e.ap_density:o.density=void 0,o.taste=e.ap_taste||void 0,o.filter=e.filter||void 0,o.sostav=e.ap_composition||void 0):e.hasOwnProperty("ap_beer")?!e.hasOwnProperty("ba_beer")&&e.hasOwnProperty("ap_beer")&&(t="ap",o.beer=e.ap_beer,o.brew=e.ap_brewary,o.style=e.ap_style,o.country=e.ap_country,o.abv=e.ap_abv,o.type=e.ap_type||void 0,o.price=e.ap_price_str,o.vol=e.ap_vol,o.tara=e.ap_tara,o.url=e.ap_url,e.hasOwnProperty("ap_desc")?o.desc=e.ap_desc:o.desc={},o.img=e.ap_img,o.past="",e.hasOwnProperty("ap_density")?o.density=e.ap_density:o.density=void 0,o.taste=e.ap_taste||void 0,o.filter=e.filter||void 0,o.sostav=e.ap_composition||void 0,$('[id*="clone"] #ba_col').remove()):(t="ba",s.score=e.ba_beer_score,s.beer=e.ba_beer,s.brew=e.ba_brewary,s.style=e.ba_style,s.category=e.ba_category,s.abv=e.ba_abv,s.url=e.ba_url,s.score_percent=Math.round(e.ba_beer_score/.05),s.img=e.ba_img,$('[id*="clone"] #ap_col').remove()),"ba"===t?p(a):("ap"===t||p(a),b(a)),n++}),0<e.pages&&function(e,a,r,s){console.log("pages: "+r+"\ndocs: "+a+"\npage: "+e.page);var t='<ul class="pagination text-center"></ul>';$("#paginator").removeClass("hidden").addClass("container").append(t),t=$("#paginator").find("ul"),1===e.page?t.append('<li class="disabled"><a>First</a></li>'):t.append('<li><a page="1">First</a></li>');var n=5<Number(e.page)?Number(e.page)-4:1;for(1!=n&&t.append('<li class="disabled"><a>...</a></li>');n<=Number(e.page)+4&&n<=r;n++)n==e.page?t.append('<li class="active"><a>'+n+"</a></li>"):t.append("<li><a page="+n+">"+n+"</a></li>"),n==Number(e.page)+4&&n<r&&t.append('<li class="disabled"><a>...</a></li>');e.page===r?t.append('<li class="disabled"><a>Last</a></li>'):t.append("<li><a page="+r+" page="+r+">Last</a></li>"),$(".pagination.text-center").find("a").click(function(e){var a,r=$(this).attr("page"),t=s.beer;console.log("page: "+r+"\n query: "+JSON.stringify(s,null,2)),a={query:s,action:"search",page:r,size:20},$('[id*="clone"]').remove(),$("#ba_jumbotron_hid").removeClass("jumbotron").addClass("hidden").after('<img id="spinner" src="../images/spinner2.gif">');var n=$.ajax({url:l,type:"POST",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",dataType:"json"});n.fail(function(e,a){console.log("Request failed.\nStatus:"+e.status+"\nStatus text: "+e.statusText+"\nError message: "+a),$("#paginator").removeClass("container").addClass("hidden").find("ul").remove(),$("#ba_jumbotron_hid").removeClass("hidden").addClass("jumbotron"),$("#spinner").remove()}),n.done(function(e){$("#paginator").removeClass("container").addClass("hidden").find("ul").remove(),$("#ba_jumbotron_hid").removeClass("hidden").addClass("jumbotron"),$("#spinner").remove(),c(e,t)})})}(e.options,e.docs,e.pages,e.query)}});"use strict";$(function(){var e="/beers/api/graphics",t=$("#chart1");t.addClass("hidden"),t.after('<img id="spinner1" src="../images/spinner2.gif" width="50%" height="50%">');var n=$("#chart2");n.addClass("hidden"),n.after('<img id="spinner2" src="../images/spinner2.gif" width="50%" height="50%">');var s=$("#chart3");s.addClass("hidden"),s.after('<img id="spinner3" src="../images/spinner2.gif" width="20%" height="20%">');var a,r=$("#chart4");r.addClass("hidden"),r.after('<img id="spinner4" src="../images/spinner2.gif" width="20%" height="20%">'),(a=$.ajax({url:e,type:"POST",data:JSON.stringify({chart:"c2"}),contentType:"application/json; charset=utf-8",dataType:"json"})).fail(function(e,a){$("#spinner1").remove(),$("#spinner2").remove(),$("#chart1").after('<div class="alert alert-danger"><strong>Error!</strong><br>Ошибка получения данных для графика 1 .<br>HTTP Status: '+e.status+" "+e.statusText+"</div>"),$("#chart2").after('<div class="alert alert-danger"><strong>Error!</strong><br>Ошибка получения данных для графика 2.<br>HTTP Status: '+e.status+" "+e.statusText+"</div>"),console.log("Request failed.\nStatus:"+e.status+"\nStatus text: "+e.statusText+"\nError message: "+a)}),a.done(function(e){if($("#spinner1").remove(),$("#spinner2").remove(),console.log("Chart 1 and 2 response => Done"),0===e.ales.length||0===e.lagers.length||0===e.hybrid.length)$("#chart1").after('<div class="alert alert-info">Не достаточно данных для построения графика 1.</div>'),$("#chart2").after('<div class="alert alert-info">Не достаточно данных для построения графика 2.</div>');else{t.removeClass("hidden"),n.removeClass("hidden");var a={datasets:[{data:[e.ales[0].count,e.lagers[0].count,e.hybrid[0].count],backgroundColor:["rgba(204,102,0,1)","rgba(255,230,153,1)","rgba(221,153,255,1)"],borderColor:["rgba(255,255,255,1)","rgba(255,255,255,1)","rgba(255,255,255,1)"],borderWidth:6}],labels:["Ales","Lagers","Hybrid"]},r={datasets:[{data:[e.ales[0].max_abv,e.lagers[0].max_abv,e.hybrid[0].max_abv],label:"max ABV.",backgroundColor:["rgba(204,102,0,1)","rgba(255,230,153,1)","rgba(221,153,255,1)"],borderColor:["rgba(255,255,255,1)","rgba(255,255,255,1)","rgba(255,255,255,1)"]}],labels:["Ales","Lagers","Hybrid"]};new Chart(t,{type:"doughnut",data:a}),new Chart(n,{type:"bar",data:r,options:{scales:{xAxes:[{stacked:!0}],yAxes:[{stacked:!0}]}}})}}),(a=$.ajax({url:e,type:"POST",data:JSON.stringify({chart:"c3"}),contentType:"application/json; charset=utf-8",dataType:"json"})).fail(function(e,a){$("#spinner3").remove(),$("#chart3").after('<div class="alert alert-danger"><strong>Error!</strong><br>Ошибка получения данных для графика 3.<br>HTTP Status: '+e.status+" "+e.statusText+"</div>"),console.log("Request failed.\nStatus:"+e.status+"\nStatus text: "+e.statusText+"\nError message: "+a)}),a.done(function(e){$("#spinner3").remove(),console.log("Chart 3 response => Done"),s.removeClass("hidden");var a=new Array(e[0].length).fill(1);a=a.map(function(){return e=Math.round,a=Math.random,"rgba("+e(255*a())+","+e(255*a())+","+e(255*a())+",1)";var e,a});var r={datasets:[{data:e[2],label:"max ABV.",backgroundColor:a,borderWidth:0}],labels:e[0]};new Chart(s,{type:"bar",data:r,options:{scales:{xAxes:[{stacked:!0}],yAxes:[{stacked:!0}]}}})});var o,i={_id:"BEER",children:[{_id:"Ale styles",children:[]},{_id:"Lager styles",children:[]},{_id:"Hybrid styles",children:[]}]};o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chart:"c4"})},d3.json(e,o).then(function(e){console.log("d3 response => Done"),$("#spinner4").remove(),r.removeClass("hidden"),i.children[0].children=e.ales,i.children[1].children=e.lagers,i.children[2].children=e.hybrid,function(){var e=d3.tree(),a=d3.hierarchy(i);e.size([1800,350]),e(a);var r=d3.select("#chart4").append("svg:svg").attr("width",600).attr("height",1800).append("svg:g").attr("transform","translate(40, 0)"),t=(r.selectAll(".link").data(a.descendants().slice(1)).enter().append("path").attr("class","link").attr("d",function(e){return"M"+e.y+","+e.x+"C"+(e.parent.y+100)+","+e.x+" "+(e.parent.y+100)+","+e.parent.x+" "+e.parent.y+","+e.parent.x}),r.selectAll(".node").data(a.descendants()).enter().append("g").attr("class",function(e){return"node"+(e.children?" node--internal":" node--leaf")}).attr("transform",function(e){return"translate("+e.y+","+e.x+")"}));t.append("circle").attr("r",2.5),t.append("text").attr("dy",3).attr("x",function(e){return e.children?-8:8}).style("text-anchor",function(e){return e.children?"end":"start"}).text(function(e){return e.children?e.data._id:e.data._id+" ["+e.data.beers+"]"})}()}).catch(function(e){console.log("d3 fetch err MSG: "+e)})});